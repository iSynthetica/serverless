dist: xenial
language: node_js
node_js:
  - 10

# We need to generate new keys for GCP
before_install:
  - openssl aes-256-cbc -K $encrypted_eb58c3e7c70a_key -iv $encrypted_eb58c3e7c70a_iv -in integration/google/credentials.json.enc -out integration/google/credentials.json -d

before_script:
  - npm install -g serverless
  - serverless --version
  - export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID_MB_FBE}
  - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY_MB_FBE}
  - export AWS_REGION=${AWS_DEFAULT_REGION_MB_FBE}
  - npm install
  - cd controllers && npm install && cd ..
  - cd integration/azure && npm install && cd ../..
  - cd integration/google && npm install && cd ../..
  - mkdir ~/.gcloud
  - mv credentials.json ~/.gcloud/credentials.json

jobs:
  include:
    - stage: deploy
      name: Deploy Milkbox Funnels Backend to Staging
      if: type = push AND tag =~ ^staging-deploy-.*$
      env: environment=staging
      script:
        - npm run build
        - rsync -r controllers/ integration/aws/dependencies/nodejs
        - rsync -r controllers/ integration/azure/controllers
        - rsync -r controllers/ integration/google/controllers
        - cd integration/aws
        - serverless deploy --stage staging --force -v
        - cd ../..
        - cd integration/azure
        - serverless deploy --stage staging --force -v
        - cd ../..
        - cd integration/google
        - serverless deploy --stage staging --force -v
        - cd ../..
    - stage: deploy
      name: Deploy Milkbox Funnels Backend to Staging
      if: type = push AND tag =~ ^deploy-.*$
      env: environment=production
      script:
        - npm run build
        - rsync -r controllers/ integration/aws/dependencies/nodejs
        - rsync -r controllers/ integration/azure/controllers
        - rsync -r controllers/ integration/google/controllers
        - cd integration/aws
        - serverless deploy --stage production --force -v
        - cd ../..
        - cd integration/azure
        - serverless deploy --stage production --force -v
        - cd ../..
        - cd integration/google
        - serverless deploy --stage production --force -v
        - cd ../..
